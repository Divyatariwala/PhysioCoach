<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Squat Coach</title>
<style>
body {
  margin: 0;
  background: #0e0e0e;
  color: white;
  font-family: "Poppins", sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
h2 {
  margin-top: 15px;
  color: #4CAF50;
}
video, canvas {
  position: absolute;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  border-radius: 12px;
}
canvas {
  z-index: 2;
}
#counterBox {
  margin-top: 580px;
  font-size: 28px;
  font-weight: bold;
}
#feedback {
  position: absolute;
  top: 40px;
  background: rgba(0,0,0,0.6);
  padding: 10px 20px;
  border-radius: 10px;
  font-size: 18px;
  text-align: center;
  color: yellow;
}
</style>
</head>
<body>
<h2>üèãÔ∏è Smart Squat Coach</h2>
<video id="video" width="640" height="480" autoplay playsinline muted></video>
<canvas id="canvas" width="640" height="480"></canvas>
<div id="feedback">Loading model...</div>
<div id="counterBox">Reps: 0</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const feedback = document.getElementById("feedback");
const counterBox = document.getElementById("counterBox");

let repCount = 0;
let stage = "up";

async function setupCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { width: 640, height: 480 }
  });
  video.srcObject = stream;
  return new Promise(resolve => {
    video.onloadedmetadata = () => resolve(video);
  });
}

function getAngle(a, b, c) {
  const ab = { x: a.x - b.x, y: a.y - b.y };
  const cb = { x: c.x - b.x, y: c.y - b.y };
  const dot = ab.x * cb.x + ab.y * cb.y;
  const magAB = Math.hypot(ab.x, ab.y);
  const magCB = Math.hypot(cb.x, cb.y);
  const radians = Math.acos(dot / (magAB * magCB));
  return radians * (180 / Math.PI);
}

function drawPose(keypoints) {
  // Red dots
  keypoints.forEach(p => {
    if (p.score > 0.4) {
      ctx.beginPath();
      ctx.arc(p.x * canvas.width, p.y * canvas.height, 5, 0, 2 * Math.PI);
      ctx.fillStyle = "red";
      ctx.fill();
    }
  });

  // Green skeleton lines
  const pairs = [
    ['left_shoulder', 'right_shoulder'],
    ['left_shoulder', 'left_elbow'], ['left_elbow', 'left_wrist'],
    ['right_shoulder', 'right_elbow'], ['right_elbow', 'right_wrist'],
    ['left_shoulder', 'left_hip'], ['right_shoulder', 'right_hip'],
    ['left_hip', 'right_hip'],
    ['left_hip', 'left_knee'], ['left_knee', 'left_ankle'],
    ['right_hip', 'right_knee'], ['right_knee', 'right_ankle']
  ];

  ctx.lineWidth = 3;
  ctx.strokeStyle = "lime";
  pairs.forEach(([a, b]) => {
    const pa = keypoints.find(p => p.name === a);
    const pb = keypoints.find(p => p.name === b);
    if (pa && pb && pa.score > 0.4 && pb.score > 0.4) {
      ctx.beginPath();
      ctx.moveTo(pa.x * canvas.width, pa.y * canvas.height);
      ctx.lineTo(pb.x * canvas.width, pb.y * canvas.height);
      ctx.stroke();
    }
  });
}

async function runSquatCoach() {
  await setupCamera();
  video.play();

  feedback.textContent = "Model loading... please wait ‚è≥";
  const detector = await poseDetection.createDetector(
    poseDetection.SupportedModels.MoveNet,
    { modelType: poseDetection.movenet.modelType.THUNDER }
  );
  feedback.textContent = "‚úÖ Ready! Show yourself from head to knees.";

  async function detectPose() {
    const poses = await detector.estimatePoses(video);
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (poses.length > 0) {
      const keypoints = poses[0].keypoints;
      drawPose(keypoints);

      const lh = keypoints.find(p => p.name === "left_hip");
      const lk = keypoints.find(p => p.name === "left_knee");
      const la = keypoints.find(p => p.name === "left_ankle");
      const ls = keypoints.find(p => p.name === "left_shoulder");

      if ([ls, lh, lk, la].some(p => !p || p.score < 0.4)) {
        feedback.style.color = "yellow";
        feedback.textContent = "‚ö†Ô∏è Move a bit closer (show from head to knees)";
      } else {
        const kneeAngle = getAngle(lh, lk, la);
        const backAngle = getAngle(ls, lh, lk);

        if (backAngle < 150) {
          feedback.style.color = "orange";
          feedback.textContent = "Keep your back straight!";
        } else if (kneeAngle < 100 && stage === "up") {
          stage = "down";
          feedback.style.color = "lightblue";
          feedback.textContent = "Nice! Go lower and hold.";
        } else if (kneeAngle > 160 && stage === "down") {
          repCount++;
          stage = "up";
          feedback.style.color = "#4CAF50";
          feedback.textContent = "Perfect squat ‚úÖ";
          counterBox.textContent = "Reps: " + repCount;
        }
      }
    } else {
      feedback.style.color = "yellow";
      feedback.textContent = "No body detected ‚Äì stand visible in frame.";
    }

    requestAnimationFrame(detectPose);
  }

  detectPose();
}

runSquatCoach();
</script>
</body>
</html>
